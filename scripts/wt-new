#!/bin/bash

# Usage: wt-new <branch-name> [base-branch]

BRANCH_NAME=$1
BASE_BRANCH=${2:-HEAD}

if [ -z "$BRANCH_NAME" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: wt-new <branch-name> [base-branch]"
  echo "–ü—Ä–∏–º–µ—Ä: wt-new feature/user-auth"
  exit 1
fi

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–º—è –≤–µ—Ç–∫–∏ –≤ –∏–º—è –ø–∞–ø–∫–∏ (–∑–∞–º–µ–Ω—è–µ–º —Å–ª—ç—à–∏ –Ω–∞ –¥–µ—Ñ–∏—Å—ã)
# feature/login -> feature-login
DIR_NAME=${BRANCH_NAME//\//-}

# –ü—É—Ç—å –∫ –Ω–æ–≤–æ–º—É worktree (—Å–æ–∑–¥–∞–µ–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏)
TARGET_DIR="../$DIR_NAME"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ –ø–∞–ø–∫–∞
if [ -d "$TARGET_DIR" ]; then
   echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ $TARGET_DIR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
   exit 1
fi

echo "üöÄ –°–æ–∑–¥–∞–µ–º worktree..."
echo "   –í–µ—Ç–∫–∞: $BRANCH_NAME"
echo "   –ü–∞–ø–∫–∞: $TARGET_DIR"
echo "   –ë–∞–∑–∞:  $BASE_BRANCH"

# –°–æ–∑–¥–∞–µ–º worktree
git worktree add -b "$BRANCH_NAME" "$TARGET_DIR" "$BASE_BRANCH"
RET=$?

if [ $RET -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ worktree."
  exit $RET
fi

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ ai-link
# –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Å–∫—Ä–∏–ø—Ç ai-link. –ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ –æ–Ω –ª–µ–∂–∏—Ç –≤ –≥–ª–∞–≤–Ω–æ–º worktree.
MAIN_WT=$(git worktree list | head -n 1 | awk '{print $1}')
AI_LINK_SCRIPT="$MAIN_WT/scripts/ai-link"

if [ -x "$AI_LINK_SCRIPT" ]; then
  echo "üîó –ó–∞–ø—É—Å–∫–∞–µ–º ai-link..."
  # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –í–ù–£–¢–†–ò –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏
  (cd "$TARGET_DIR" && "$AI_LINK_SCRIPT")
else
  echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç ai-link –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: $AI_LINK_SCRIPT"
  echo "   –í–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é."
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:"
echo "cd $TARGET_DIR"