#!/bin/bash

# Usage: wt-kill <path-fragment-or-branch> [-D|--delete-branch]

QUERY=""
DELETE_BRANCH=false

# –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
for arg in "$@"; do
  case $arg in
    -D|--delete-branch)
      DELETE_BRANCH=true
      ;;
    *)
      if [ -z "$QUERY" ]; then
        QUERY="$arg"
      fi
      ;;
  esac
done

if [ -z "$QUERY" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: wt-kill <–ø—É—Ç—å-–∏–ª–∏-–≤–µ—Ç–∫–∞> [-D|--delete-branch]"
  echo "   -D, --delete-branch: –£–¥–∞–ª–∏—Ç—å —Ç–∞–∫–∂–µ —Å–≤—è–∑–∞–Ω–Ω—É—é git-–≤–µ—Ç–∫—É"
  exit 1
fi

# –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ worktree, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å—É.
# –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (Main Worktree), —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è —Å–∫—Ä–∏–ø—Ç–æ–º.
# grep –∏—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –ø—É—Ç–∏ –∏–ª–∏ –∏–º–µ–Ω–∏ –≤–µ—Ç–∫–∏.
MATCH_LINE=$(git worktree list | tail -n +2 | grep "$QUERY" | head -n 1)

if [ -z "$MATCH_LINE" ]; then
  echo "‚ùå Worktree, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π '$QUERY', –Ω–µ –Ω–∞–π–¥–µ–Ω (–∏–ª–∏ —ç—Ç–æ Main worktree)."
  git worktree list
  exit 1
fi

# –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∏ –≤–µ—Ç–∫—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
WT_PATH=$(echo "$MATCH_LINE" | awk '{print $1}')
WT_BRANCH=$(echo "$MATCH_LINE" | awk '{print $3}' | sed 's/\[//;s/\]//')

echo "üéØ –ù–∞–π–¥–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ:"
echo "   –ü–∞–ø–∫–∞: $WT_PATH"
echo "   –í–µ—Ç–∫–∞: $WT_BRANCH"
if [ "$DELETE_BRANCH" = true ]; then
    echo "   üóë  –í–ï–¢–ö–ê –ë–£–î–ï–¢ –£–î–ê–õ–ï–ù–ê! (-D)"
fi
echo ""
echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –ü–∞–ø–∫–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (--force)."
read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (y/N) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "–û—Ç–º–µ–Ω–∞."
    exit 0
fi

# –£–¥–∞–ª—è–µ–º worktree
git worktree remove --force "$WT_PATH"

if [ $? -eq 0 ]; then
  echo "‚úÖ –ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞."
  
  # –£–¥–∞–ª—è–µ–º –≤–µ—Ç–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª —Ñ–ª–∞–≥
  if [ "$DELETE_BRANCH" = true ]; then
    git branch -D "$WT_BRANCH"
    echo "‚úÖ –í–µ—Ç–∫–∞ '$WT_BRANCH' —É–¥–∞–ª–µ–Ω–∞."
  else
    echo "‚ÑπÔ∏è  –í–µ—Ç–∫–∞ '$WT_BRANCH' —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ -D –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)."
  fi
else
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ worktree."
fi