#!/bin/bash

# ==============================================================================
# wt-setup: Worktree Environment Setup Utility
# 
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ –ì–ª–∞–≤–Ω–æ–≥–æ Worktree (Main) –≤ —Ç–µ–∫—É—â–∏–π.
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è: LINK (—Å–∏–º–ª–∏–Ω–∫), COPY (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ).
# –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑:
# 1. .git/info/exclude (–≤—Å–µ–≥–¥–∞ –∫–∞–∫ LINK)
# 2. .worktree-config (—è–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: "VERB FILE")
# ==============================================================================

# --- 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ---

# –ù–∞—Ö–æ–¥–∏–º Main Worktree (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Å–ø–∏—Å–∫–µ)
MAIN_WORKTREE=$(git worktree list | head -n 1 | awk '{print $1}')

if [ -z "$MAIN_WORKTREE" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Main Worktree."
  exit 1
fi

echo "üîç Main Worktree: $MAIN_WORKTREE"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ –∫–æ–Ω—Ñ–∏–≥–∞–º
GIT_COMMON_DIR=$(git rev-parse --git-common-dir)
EXCLUDE_FILE="$GIT_COMMON_DIR/info/exclude"
CONFIG_FILE="$MAIN_WORKTREE/.worktree-config"

# –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ "ACTION|FILE"
TASKS=()

# --- 2. –§—É–Ω–∫—Ü–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ ---

# –§—É–Ω–∫—Ü–∏—è: parse_exclude_file
# –ß–∏—Ç–∞–µ—Ç .git/info/exclude, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —ç—Ç–æ —Ñ–∞–π–ª –¥–ª—è LINK
parse_exclude_file() {
  local file="$1"
  if [ -f "$file" ]; then
    echo "üìÑ –ß–∏—Ç–∞–µ–º exclude: $file"
    while IFS= read -r line || [[ -n "$line" ]]; do
      line=$(echo "$line" | xargs) # Trim
      if [[ "$line" =~ ^#.* ]] || [[ -z "$line" ]]; then continue; fi
      TASKS+=("LINK|$line")
    done < "$file"
  fi
}

# –§—É–Ω–∫—Ü–∏—è: parse_config_file
# –ß–∏—Ç–∞–µ—Ç .worktree-config, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å "VERB FILE"
parse_config_file() {
  local file="$1"
  if [ -f "$file" ]; then
    echo "üìÑ –ß–∏—Ç–∞–µ–º config:  $file"
    while IFS= read -r line || [[ -n "$line" ]]; do
      line=$(echo "$line" | xargs) # Trim
      if [[ "$line" =~ ^#.* ]] || [[ -z "$line" ]]; then continue; fi

      # –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ —Å–ª–æ–≤–∞
      # –ü—Ä–∏–º–µ—Ä: "COPY .env" -> arg1="COPY", arg2=".env"
      # –ü—Ä–∏–º–µ—Ä: "scripts"   -> arg1="scripts", arg2=""
      read -r arg1 arg2 <<< "$line"

      if [ -n "$arg2" ]; then
        # –§–æ—Ä–º–∞—Ç: VERB FILE
        local verb=$(echo "$arg1" | tr '[:lower:]' '[:upper:]')
        TASKS+=("$verb|$arg2")
      else
        # –§–æ—Ä–º–∞—Ç: FILE (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é LINK)
        TASKS+=("LINK|$arg1")
      fi
    done < "$file"
  fi
}

# --- 3. –°–±–æ—Ä –∑–∞–¥–∞—á ---

# –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ COPY –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π LINK –∏–∑ exclude, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞.
# –õ–æ–≥–∏–∫–∞: –ú—ã –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏ –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç), –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å.
# –ó–Ω–∞—á–∏—Ç, –±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –ø–µ—Ä–≤—ã–º–∏?
# –ù–µ—Ç, –º—ã —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ: –¥–æ–±–∞–≤–∏–º –≤—Å—ë, –∞ –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏–º.

parse_config_file "$CONFIG_FILE"
parse_exclude_file "$EXCLUDE_FILE"


# --- 4. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ ---

echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

for TASK in "${TASKS[@]}"; do
  ACTION="${TASK%%|*}"
  ITEM="${TASK#*|}"
  
  # === –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ RUN ===
  if [ "$ACTION" == "RUN" ]; then
    echo "üöÄ RUN: $ITEM"
    eval "$ITEM"
    continue
  fi

  # === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (LINK / COPY) ===
  
  SOURCE="$MAIN_WORKTREE/$ITEM"
  TARGET="./$ITEM"

  # 1. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º glob-–ø–∞—Ç—Ç–µ—Ä–Ω—ã (*.log), –º—ã –∏—Ö –Ω–µ —É–º–µ–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
  if [[ "$ITEM" == *"*"* ]]; then continue; fi

  # 2. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –≤ Main
  if [ ! -e "$SOURCE" ]; then
    # echo "‚ö™Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: $ITEM (–Ω–µ—Ç –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ)"
    continue
  fi

  # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
  if [ -e "$TARGET" ]; then
    # –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    
    # –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º COPY, –∞ —Ç–∞–º LINK -> —É–¥–∞–ª—è–µ–º –ª–∏–Ω–∫, –∫–æ–ø–∏—Ä—É–µ–º
    if [ "$ACTION" == "COPY" ] && [ -L "$TARGET" ]; then
       rm "$TARGET"
       # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ cp)
    
    # –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º LINK, –∞ —Ç–∞–º —É–∂–µ LINK -> –æ–±–Ω–æ–≤–ª—è–µ–º (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
    elif [ "$ACTION" == "LINK" ] && [ -L "$TARGET" ]; then
       ln -sf "$SOURCE" "$TARGET"
       # echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω –ª–∏–Ω–∫: $ITEM"
       continue

    # –ï—Å–ª–∏ —Ç–∞–º —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ –ª–∏–Ω–∫), –º—ã –µ–≥–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º (Safety first)
    elif [ ! -L "$TARGET" ]; then
       echo "‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: $ITEM (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é)"
       continue
    fi
  fi

  # 4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
  if [ "$ACTION" == "COPY" ]; then
     # –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª –≤—Å—ë –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —ç—Ç–æ –±—ã–ª —Å–∏–º–ª–∏–Ω–∫, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É–¥–∞–ª–∏–ª–∏ –≤—ã—à–µ),
     # –∑–Ω–∞—á–∏—Ç –ø—É—Ç—å —Å–≤–æ–±–æ–¥–µ–Ω. –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª —Ñ–∞–π–ª, –º—ã –±—ã –≤—ã—à–ª–∏ –ø–æ continue –≤—ã—à–µ.
     
     cp -R "$SOURCE" "$TARGET"
     echo "üìã COPY: $ITEM"
     
  elif [ "$ACTION" == "LINK" ]; then
     ln -sf "$SOURCE" "$TARGET"
     echo "üîó LINK: $ITEM"
  else
     echo "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: $ACTION –¥–ª—è $ITEM"
  fi

done

echo "üéâ –ì–æ—Ç–æ–≤–æ!"